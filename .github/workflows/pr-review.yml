name: PR Review with Qodo PR Agent
on:
  pull_request:
    # types: [opened, synchronize, labeled, unlabeled]  # will trigger @ every change | won't review ‚ö†Ô∏è
    types: [ opened, reopened, ready_for_review ]
  issue_comment:
    types: [ created ]

jobs:
  pr_agent_job:
    name: Run PR Agent action; describes PR, adds changelog, reviews PR and replies to comments
    if: ${{ github.event.sender.type != 'Bot' && github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
    env:
      changelog_instructions: |
        Follow this format:
        - title: (DATE) [version_from_pyproject.toml](https://_PR_LINK_) followed by ___ separator
        - body should ONLY contain bullets of changes, no additional texts like "Added", etc
        - start the bullet with emoji: üöÄ rocket for the new feature üêû bug for bugfix 
        üî• fire for improvement üìÑ paper for documentation-related and üö® alarm for vulnerability fix
    
    steps:
      - name: Trigger PR Agent action step
        id: pragent
        uses: qodo-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          # https://docs.litellm.ai/docs/providers
          CONFIG__MODEL: "deepseek/deepseek-chat"
          CONFIG__CUSTOM_MODEL_MAX_TOKENS: "64000"
          OPENAI__API_BASE: "https://api.deepseek.com"
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          # https://qodo-merge-docs.qodo.ai/tools/review/#configuration-options
          pr_reviewer.num_max_findings: 5
          pr_reviewer.require_score_review: true
          # there also are e.g. require_ticket_analysis_review for Jira links, etc
          pr_update_changelog.push_changelog: true
          pr_update_changelog.extra_instructions: ${{ env.changelog_instructions }}

      - name: Comment on PR with instructions  # just when we open the PR
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.INSTRUCTIONS
            });
        env:
          INSTRUCTIONS: |
            Ask a question to PR Agent using `\ask` "..." command üí¨
            
            Use `\help` to get all the commands available